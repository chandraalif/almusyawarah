<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat Musholla Al Musyawarah Cluster Rosewood Cileungsi Hijau</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="icon" type="image/png" href="icon-almusyawarah.png" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
    <style type="text/tailwindcss">
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-mist-950);
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url(bg-pattern.png);
            background-repeat: repeat;
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        .digital-clock {
            font-family: 'Space Mono', sans-serif;
        }
        .prayer-card.active {
            background: linear-gradient(135deg, var(--color-emerald-600) 0%, var(--color-emerald-900) 100%);
            border-color: var(--color-amber-200);
            transform: scale(1.06);
        }
        @keyframes marquee {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 60s linear infinite;
        }
        .fade-in {
            animation: fadeIn 1.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(1.05); }
            to { opacity: 1; transform: scale(1); }
        }
        .standby-mode {
            background-color: black;
            z-index: 9999;
        }
        .pulse-emerald {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Menghilangkan cursor default saat hover judul agar benar-benar tersembunyi fungsinya */
        .toggle-fs {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Standby Overlay -->
    <div id="standbyOverlay" class="fixed inset-0 standby-mode hidden flex flex-col items-center justify-center text-center p-10">
        <img src="ornament.png" alt="-" class="w-60 mb-12 rotate-180 opacity-80">
        <h1 class="text-8xl font-extrabold mb-8 text-emerald-500">WAKTUNYA SHOLAT</h1>
        <p class="text-4xl text-mist-400">Mohon menonaktifkan atau senyapkan HP Anda</p>
        <div class="mt-20 border-t border-amber-400 pt-14">
            <p class="text-6xl text-mist-600 mb-8">سَوُّوا ‌صُفُوفَكُمْ، فَإِنَّ تَسْوِيَةَ الصُّفُوفِ مِنْ إِقَامَةِ الصَّلَاةِ</p>
            <p class="text-3xl text-mist-600 italic">“Luruskan shaf kalian, sesungguhnya meluruskan shaf termasuk dari menegakkan shalat”<br />(HR. Bukhari no.723)</p>
        </div>
        <img src="ornament.png" alt="-" class="w-60 mt-12 opacity-80">
    </div>

    <!-- Header: Title & Time -->
    <header class="h-[15%] flex items-center justify-between px-12 bg-linear-to-bl to-mist-950 from-emerald-950 border-b-4 border-amber-200 rounded-b-3xl">
        <div class="flex flex-row items-center gap-8">
            <img id="mushallaTitle" src="logo-dkm.png" alt="Icon Musholla Al Musyawarah" class="w-24 h-24 bg-white rounded-lg p-1 scale-110 hover:scale-125 cursor-pointer transition-transform duration-300">
            <div class="flex flex-col">
                <h1 class="text-5xl font-bold text-white">Musholla Al Musyawarah</h1>
                <p class="text-2xl text-emerald-500 font-medium">Cluster Rosewood, Cileungsi Hijau</p>
            </div>
        </div>
        <div class="text-right">
            <div id="digitalClock" class="digital-clock text-7xl font-bold text-white leading-none">00:00:00</div>
            <div id="currentDate" class="text-2xl text-emerald-400 font-semibold mt-1">---</div>
        </div>
    </header>

    <!-- Main Content: Split Layout -->
    <main class="h-[75%] flex flex-row overflow-hidden">
        <!-- Left Side: Full Image Slider -->
        <section class="w-2/3 h-full p-8">
            <div class="w-full h-full relative overflow-hidden rounded-2xl border border-amber-200 bg-mist-950">
                <div id="photoSlider" class="w-full h-full">
                    <!-- Foto akan dimasukkan di sini -->
                </div>
                <!-- Overlay Menuju Adzan (15 Menit Sebelum) -->
                <div id="countdownAdzan" class="hidden absolute inset-0 bg-emerald-950/80 flex flex-col items-center justify-center text-center p-8 z-20 fade-in">
                    <h2 class="text-4xl font-bold text-emerald-400 mb-6 uppercase tracking-widest">Menuju Adzan <span id="nextPrayerNameAdzan">...</span></h2>
                    <div id="timerAdzan" class="digital-clock text-[10rem] font-black text-white leading-none">00:00</div>
                </div>
                <!-- Overlay Menuju Iqomah (Setelah Waktu Adzan Masuk) -->
                <div id="countdownIqomah" class="hidden absolute inset-0 bg-emerald-950 flex flex-col items-center justify-center text-center p-8 z-30 fade-in border-r-8 border-emerald-500">
                    <div class="mb-4 bg-emerald-500 text-emerald-950 px-6 py-2 rounded-full text-2xl font-black uppercase tracking-widest pulse-emerald">Waktu Adzan Telah Tiba</div>
                    <h2 class="text-5xl font-bold text-white mb-8 uppercase tracking-widest">Menuju Iqomah <span id="nextPrayerNameIqomah">...</span></h2>
                    <div id="timerIqomah" class="digital-clock text-[12rem] font-black text-white leading-none shadow-emerald-500/20">00:00</div>
                    <p class="text-3xl text-emerald-300 mt-10 font-semibold">Silahkan Menunaikan Sholat Sunnah</p>
                </div>
            </div>
        </section>

        <!-- Right Side: Prayer Schedule -->
        <section class="w-1/3 h-full p-8 flex flex-col justify-center gap-4">
            <div class="grid grid-cols-1 gap-4 h-full">
                <div id="card-Subuh" class="prayer-card bg-emerald-950/40 backdrop-blur-sm px-10 py-4 rounded-3xl border border-amber-200 flex justify-between items-center transition-all duration-700">
                    <span class="text-4xl font-bold text-emerald-100">SUBUH</span>
                    <span id="time-Subuh" class="digital-clock text-6xl font-bold text-white">--:--</span>
                </div>
                <div id="card-Terbit" class="prayer-card bg-emerald-950/40 backdrop-blur-sm px-10 py-4 rounded-3xl border border-amber-200 flex justify-between items-center opacity-70">
                    <span class="text-3xl font-bold text-emerald-200 tracking-wider">TERBIT</span>
                    <span id="time-Terbit" class="digital-clock text-5xl font-bold text-emerald-100">--:--</span>
                </div>
                <div id="card-Dhuhr" class="prayer-card bg-emerald-950/40 backdrop-blur-sm px-10 py-4 rounded-3xl border border-amber-200 flex justify-between items-center transition-all duration-700">
                    <span class="text-4xl font-bold text-emerald-100">DZUHUR</span>
                    <span id="time-Dhuhr" class="digital-clock text-6xl font-bold text-white">--:--</span>
                </div>
                <div id="card-Asr" class="prayer-card bg-emerald-950/40 backdrop-blur-sm px-10 py-4 rounded-3xl border border-amber-200 flex justify-between items-center transition-all duration-700">
                    <span class="text-4xl font-bold text-emerald-100">ASHAR</span>
                    <span id="time-Asr" class="digital-clock text-6xl font-bold text-white">--:--</span>
                </div>
                <div id="card-Maghrib" class="prayer-card bg-emerald-950/40 backdrop-blur-sm px-10 py-4 rounded-3xl border border-amber-200 flex justify-between items-center transition-all duration-700">
                    <span class="text-4xl font-bold text-emerald-100">MAGHRIB</span>
                    <span id="time-Maghrib" class="digital-clock text-6xl font-bold text-white">--:--</span>
                </div>
                <div id="card-Isha" class="prayer-card bg-emerald-950/40 backdrop-blur-sm px-10 py-4 rounded-3xl border border-amber-200 flex justify-between items-center transition-all duration-700">
                    <span class="text-4xl font-bold text-emerald-100">ISYA</span>
                    <span id="time-Isha" class="digital-clock text-6xl font-bold text-white">--:--</span>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer: Running Text -->
    <footer class="h-[10%] bg-emerald-700 flex items-center overflow-hidden border-t-4 border-amber-200">
        <div id="runningTextContainer" class="animate-marquee whitespace-nowrap text-5xl font-bold text-white px-4">
            Selamat Datang di Musholla Al-Musyawarah Cluster Rosewood
            &nbsp;&nbsp; • &nbsp;&nbsp;
            Mari tingkatkan iman dan taqwa kita kepada Allah SWT
            &nbsp;&nbsp; • &nbsp;&nbsp;
            Untuk donasi pembangunan dan kegiatan Musholla, silakan salurkan di rekening berikut: BCA 740-200-6334 a.n. Tri Mulyawan
            &nbsp;&nbsp; • &nbsp;&nbsp;
        </div>
    </footer>

    <script>
        /**
         * PENGATURAN / CONFIGURATION
         */
        const CONFIG = {
            // Lokasi untuk perhitungan jadwal sholat
            locationName: 'Cileungsi',
            latitude: -6.3975294,
            longitude: 106.9599001,
            // Konfigurasi jeda Iqomah masing-masing (dalam menit)
            iqomahDurations: {
                'Subuh': 15,
                'Dhuhr': 10,
                'Asr': 10,
                'Maghrib': 15,
                'Isha': 10
            },
            sholatDuration: 15, // Menit layar hitam saat sholat sedang berlangsung
            countdownAdzanStart: 15, // Menit mulai muncul countdown adzan
            // Konfigurasi penyesuaian waktu (tune) untuk setiap sholat dalam menit (positif atau negatif)
            tune: {
                'Fajr': 1,
                'Sunrise': 0,
                'Dhuhr': 1,
                'Asr': 4,
                'Maghrib': 1,
                'Isha': 1
            },
            // Nama file audio untuk adzan dan iqomah
            audioAdzan: 'adzan-beep.mp3',
            audioIqomah: 'iqomah-beep.mp3',
            runningText: "Selamat Datang di Musholla Al-Musyawarah Cluster Rosewood   •   Mari tingkatkan iman dan taqwa kita kepada Allah SWT   •   Untuk donasi pembangunan dan kegiatan Musholla, silakan salurkan di rekening berikut: BCA 740-200-6334 a.n. Tri Mulyawan",
            // Daftar foto untuk slider
            photos: [
                "foto-musholla.jpeg",
                "kajian-quran.jpeg",
                "sholat-berjamaah.jpeg",
                "sanlat-anak.jpeg"
            ],
            photosCaption: [
                "Musholla Al Musyawarah",
                "Kajian Al-Qur'an",
                "Shalat Berjama'ah",
                "Sanlat Anak-anak"
            ]
        };

        let prayerTimes = {};
        let photoIndex = 0;
        let lastTriggeredState = 'NORMAL';
        let audioPermissionGranted = false;

        /**
         * AUDIO FUNCTIONS (MP3 Files)
         */
        function playAudioFile(src) {
            // Browser membutuhkan interaksi user sebelum memutar audio
            if (!audioPermissionGranted) {
                console.warn("Audio belum diizinkan. Klik pada layar terlebih dahulu!");
                return;
            }
            const audio = new Audio(src);
            audio.play().catch(err => console.error("Gagal memutar audio: ", err));
        }

        /**
         * CORE LOGIC
         */
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\./g, ':');
            
            const clockEl = document.getElementById('digitalClock');
            if (clockEl) clockEl.textContent = timeStr;

            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateEl = document.getElementById('currentDate');
            if (dateEl) dateEl.textContent = now.toLocaleDateString('id-ID', dateOptions);

            checkPrayerStatus(now);
        }

        // 2. Ambil Jadwal Sholat API
        async function fetchPrayerTimes() {
            try {
                const now = new Date();
                const url = `https://api.aladhan.com/v1/calendar?latitude=${CONFIG.latitude}&longitude=${CONFIG.longitude}&method=20&month=${now.getMonth() + 1}&year=${now.getFullYear()}&tune=0,${CONFIG.tune.Fajr},${CONFIG.tune.Sunrise},${CONFIG.tune.Dhuhr},${CONFIG.tune.Asr},${CONFIG.tune.Maghrib},0,${CONFIG.tune.Isha},0`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.data) {
                    const todayData = data.data[now.getDate() - 1].timings;
                    const cleanTimings = {};
                    for (let key in todayData) {
                        cleanTimings[key] = todayData[key].split(' ')[0];
                    }
                    prayerTimes = cleanTimings;
                    updatePrayerDisplay();
                }
            } catch (error) { console.error("Gagal mengambil data jadwal sholat. Galat: ", error); }
        }

        function updatePrayerDisplay() {
            const map = {
                'Subuh': 'Fajr',
                'Terbit': 'Sunrise',
                'Dhuhr': 'Dhuhr',
                'Asr': 'Asr',
                'Maghrib': 'Maghrib',
                'Isha': 'Isha'
            };

            for (let id in map) {
                const el = document.getElementById(`time-${id}`);
                if (el && prayerTimes[map[id]]) el.textContent = prayerTimes[map[id]];
            }
        }

        // 3. Logika Countdown & Standby
        function checkPrayerStatus(now) {
            if (!prayerTimes.Fajr) return;

            const prayers = [
                { id: 'Subuh', label: 'Subuh', time: prayerTimes.Fajr },
                { id: 'Dhuhr', label: 'Dzuhur', time: prayerTimes.Dhuhr },
                { id: 'Asr', label: 'Ashar', time: prayerTimes.Asr },
                { id: 'Maghrib', label: 'Maghrib', time: prayerTimes.Maghrib },
                { id: 'Isha', label: 'Isya', time: prayerTimes.Isha }
            ];

            const nowTotalSec = (now.getHours() * 3600) + (now.getMinutes() * 60) + now.getSeconds();
            let state = 'NORMAL'; 
            let activePrayer = null; // Sholat yang sedang fase countdown/standby
            let nextPrayerToHighlight = null; // Sholat terdekat berikutnya untuk warna emerald
            let remainingSec = 0;

            // Bersihkan semua highlight emerald dulu
            prayers.forEach(p => {
                const card = document.getElementById(`card-${p.id}`);
                if (card) card.classList.remove('active');
            });

            // Mencari sholat yang sedang aktif fase-nya (Adzan/Iqomah/Sholat)
            prayers.forEach(p => {
                const [h, m] = p.time.split(':').map(Number);
                const pTotalSec = (h * 3600) + (m * 60);
                const diffSec = pTotalSec - nowTotalSec;

                // Ambil durasi Iqomah spesifik untuk sholat ini
                const iqomahSec = (CONFIG.iqomahDurations[p.id] || 10) * 60;
                const sholatSec = CONFIG.sholatDuration * 60;

                // 1. Fase Menuju Adzan
                if (diffSec > 0 && diffSec <= (CONFIG.countdownAdzanStart * 60)) {
                    state = 'ADZAN_COUNTDOWN';
                    activePrayer = p;
                    remainingSec = diffSec;
                } 
                // 2. Fase Menuju Iqomah (Antara Adzan dan Iqomah Selesai)
                else if (diffSec <= 0 && diffSec > -iqomahSec) {
                    state = 'IQOMAH_COUNTDOWN';
                    activePrayer = p;
                    remainingSec = iqomahSec + diffSec;
                }
                // 3. Fase Sholat (Standby)
                else if (diffSec <= -iqomahSec && diffSec > -(iqomahSec + sholatSec)) {
                    state = 'SHOLAT_MODE';
                }
            });

            // Trigger Audio on State Change
            if (state !== lastTriggeredState) {
                if (state === 'IQOMAH_COUNTDOWN') {
                    playAudioFile(CONFIG.audioAdzan);
                } else if (state === 'SHOLAT_MODE') {
                    playAudioFile(CONFIG.audioIqomah);
                }
                lastTriggeredState = state;
            }

            // Mencari HANYA SATU sholat terdekat berikutnya untuk di-highlight hijau
            // Jika sedang dalam fase countdown sholat tertentu, maka sholat itulah yang di-highlight
            if (activePrayer) {
                nextPrayerToHighlight = activePrayer;
            } else {
                // Jika sedang normal, cari sholat pertama yang waktunya > sekarang
                nextPrayerToHighlight = prayers.find(p => {
                    const [h, m] = p.time.split(':').map(Number);
                    return (h * 3600 + m * 60) > nowTotalSec;
                });
                // Jika sudah lewat Isya, maka sholat berikutnya adalah Subuh besok
                if (!nextPrayerToHighlight) nextPrayerToHighlight = prayers[0];
            }

            // Terapkan highlight hanya pada satu kartu sholat
            if (nextPrayerToHighlight) {
                const card = document.getElementById(`card-${nextPrayerToHighlight.id}`);
                if (card) card.classList.add('active');
            }

            updateUIState(state, activePrayer, remainingSec);
        }

        function updateUIState(state, prayer, seconds) {
            const overlayAdzan = document.getElementById('countdownAdzan');
            const overlayIqomah = document.getElementById('countdownIqomah');
            const overlayStandby = document.getElementById('standbyOverlay');
            
            // Reset All
            overlayAdzan.classList.add('hidden');
            overlayIqomah.classList.add('hidden');
            overlayStandby.classList.add('hidden');

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            };

            if (state === 'ADZAN_COUNTDOWN') {
                overlayAdzan.classList.remove('hidden');
                document.getElementById('nextPrayerNameAdzan').textContent = prayer.label;
                document.getElementById('timerAdzan').textContent = formatTime(seconds);
                document.getElementById(`card-${prayer.id}`).classList.add('active');
            } 
            else if (state === 'IQOMAH_COUNTDOWN') {
                overlayIqomah.classList.remove('hidden');
                document.getElementById('nextPrayerNameIqomah').textContent = prayer.label;
                document.getElementById('timerIqomah').textContent = formatTime(seconds);
                document.getElementById(`card-${prayer.id}`).classList.add('active');
            }
            else if (state === 'SHOLAT_MODE') {
                overlayStandby.classList.remove('hidden');
            }
        }

        function initSlider() {
            updateSlider();
            setInterval(updateSlider, 5000);
        }

        function updateSlider() {
            const container = document.getElementById('photoSlider');
            if (!container) return;
            if (CONFIG.photosCaption[photoIndex]) {
                container.innerHTML = `<div class="fade-in w-full h-full relative"><img src="${CONFIG.photos[photoIndex]}" alt="${CONFIG.photosCaption[photoIndex]}" class="w-full h-full object-cover"><div class="absolute top-4 left-4 text-center text-white text-xl bg-mist-950/70 rounded-lg p-4">${CONFIG.photosCaption[photoIndex]}</div></div>`;
            } else {
                container.innerHTML = `<div class="fade-in w-full h-full relative"><img src="${CONFIG.photos[photoIndex]}" alt="Foto ${photoIndex + 1}" class="w-full h-full object-cover"></div>`;
            }
            photoIndex = (photoIndex + 1) % CONFIG.photos.length;
        }

        // Fungsi Fullscreen
        function toggleFullScreen() {
            audioPermissionGranted = true; // Izinkan audio saat interaksi
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        window.onload = () => {
            fetchPrayerTimes();
            initSlider();
            document.getElementById('runningTextContainer').textContent = CONFIG.runningText;

            // Pasang event listener ke judul
            const title = document.getElementById('mushallaTitle');
            if (title) {
                title.addEventListener('click', toggleFullScreen);
            }

            // Inisialisasi audio pada klik manapun di dokumen
            document.addEventListener('click', () => {
                audioPermissionGranted = true;
            }, { once: true });

            setInterval(updateClock, 1000);
            setInterval(fetchPrayerTimes, 3600000);
        };
    </script>
</body>
</html>